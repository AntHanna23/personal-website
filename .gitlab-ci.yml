before_script:
  - eval $(ssh-agent -s)
  - whoami
  - ssh-add /var/lib/gitlab-runner/.ssh/gitlab-runner

variables:
  - ANSIBLE_USER: "anthonyhanna"
  
stages:
  - build
  - test
  - deploy
  - cleanup
  
  
build-web-container: 
   stage: build
   script:
    - docker build -t ajhanna/website .
    - docker run -d --name test_container"$(date +'%d-%m-%Y-%H%M')" -p  80:80 ajhanna/website 
    
test-containers-available:
    stage: test
    script:    
    - curl --fail localhost:80
    - curl --fail localhost:80/Documentation/

deploy_with_ansible:
  stage: deploy
  script:
   - ansible-playbook ./ansible-playbooks/update.yaml --user $ANSIBLE_USER
   - ansible-playbook ./ansible-playbooks/deploy-website.yaml --user $ANSIBLE_USER

  only: 
   - master
    
cleanup:
    stage: cleanup
    script: 
     - docker stop test_container"$(date +'%d-%m-%Y-%H%M')"
    rules:
     - when: always